# cd tests
# docker compose run nautical-backup-test1 --exit-code-from nautical-backup-test1
# docker compose run nautical-backup-test2 --exit-code-from nautical-backup-test2
# docker compose run nautical-backup-test3
# docker compose run nautical-backup-test4

services:  
  nautical-backup-test1:
    image: minituff/nautical-test # Use the local image
    container_name: nautical-backup-test1
    hostname: nautical-backup-test1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./source:/app/source
      - ./destination:/app/destination
      - $PWD:/tests # This file will be run from the /tests directory, therefore it will be /tests:/tests
    environment:
      - TZ=America/Phoenix # Must not observe DST
      - BACKUP_ON_START=true
      - EXIT_AFTER_INIT=true
      - CRON_SCHEDULE=0 8 * * *
      - REPORT_FILE=false
      - TEST_MODE=1
      - S6_CMD_WAIT_FOR_SERVICES_MAXTIME=0 # Required since teh tests take so long
      - S6_KILL_GRACETIME=100 # How long until S6 kills
  
  nautical-backup-test2:
    image: minituff/nautical-test # Use the local image
    container_name: nautical-backup-test2
    hostname: nautical-backup-test2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./source:/app/source
      - ./destination:/app/destination
      - $PWD:/tests # This file will be run from the /tests directory, therefore it will be /tests:/tests
    environment:
      - TEST_MODE=2
      - S6_CMD_WAIT_FOR_SERVICES_MAXTIME=0 # Required since teh tests take so long
      - S6_KILL_GRACETIME=100 # How long until S6 kills

  nautical-backup-test3:
    image: minituff/nautical-test # Use the local image
    container_name: nautical-backup-test3
    hostname: nautical-backup-test3
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./source:/app/source
      - ./destination:/app/destination
      - $PWD:/tests # This file will be run from the /tests directory, therefore it will be /tests:/tests
    environment:
      - TEST_MODE=3
      - S6_CMD_WAIT_FOR_SERVICES_MAXTIME=0 # Required since teh tests take so long
      - S6_KILL_GRACETIME=100 # How long until S6 kills

  # NOT RUN IN CI
  nautical-backup-test4:
    image: minituff/nautical-test # Use the local image
    container_name: nautical-backup-test4
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${LOCAL_WORKSPACE_FOLDER-./}\tests\source:/app/source
      - ${LOCAL_WORKSPACE_FOLDER-./}\tests\destination:/app/destination
      - ${LOCAL_WORKSPACE_FOLDER-./}\pkg:/app
      - ${LOCAL_WORKSPACE_FOLDER-./}\tests:/tests
    ports:
      - "8069:8069/tcp"
    environment:
      - TEST_MODE=4 # Do not run coverage, but run all unit tests
      - S6_CMD_WAIT_FOR_SERVICES_MAXTIME=0 # Required since teh tests take so long
      - S6_KILL_GRACETIME=100 # How long until S6 kills
  
  # NOT RUN IN CI
  nautical-backup-test5:
    image: minituff/nautical-test # Use the local image
    container_name: nautical-backup-test5
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${LOCAL_WORKSPACE_FOLDER-./}\tests\source:/app/source
      - ${LOCAL_WORKSPACE_FOLDER-./}\tests\destination:/app/destination
      - ${LOCAL_WORKSPACE_FOLDER-./}\pkg:/app
      - ${LOCAL_WORKSPACE_FOLDER-./}\dev\config:/config
      - ${LOCAL_WORKSPACE_FOLDER-./}\api:/api
      - ${LOCAL_WORKSPACE_FOLDER-./}\tests:/tests
    ports:
      - "8069:8069/tcp"
    environment:
      - TEST_MODE=0 # Do not run coverage, but run all unit tests
      - BACKUP_ON_START=true
      - S6_CMD_WAIT_FOR_SERVICES_MAXTIME=0 # Required since teh tests take so long
      - S6_KILL_GRACETIME=100 # How long until S6 kills
    # entrypoint: ["sleep", "infinity"]
    entrypoint: ["python3", "/app/backup.py"]